{% extends "base.html" %}
{% block title %}History{% endblock %}
{% block nav_history_active %}active{% endblock %}

{% block content %}
<div class="history-page">
    <div class="history-header">
        <h2>Session History</h2>
        <span class="history-count">{{ sessions|length }} session{{ 's' if sessions|length != 1 }}</span>
        {% if sessions|selectattr("status", "equalto", "active")|list %}
        <button class="btn btn-outline btn-sm" id="clearInactiveBtn" style="margin-left: auto;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Clear inactive sessions
        </button>
        {% endif %}
    </div>

    {% if sessions %}
    <div class="history-table-wrap">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Session</th>
                    <th>Patient</th>
                    <th>Status</th>
                    <th>Condition</th>
                    <th>Type</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for s in sessions %}
                <tr class="history-row" data-session="{{ s.session_id }}">
                    <td class="history-id">{{ s.session_id[:16] }}...</td>
                    <td>{{ s.patient_name or '—' }}</td>
                    <td>
                        <span class="status-badge status-{{ s.status }}">{{ s.status }}</span>
                    </td>
                    <td>{{ s.condition_name or '—' }}</td>
                    <td>
                        {% if s.result_type %}
                        <span class="type-badge type-{{ s.result_type }}">{{ s.result_type }}</span>
                        {% else %}
                        —
                        {% endif %}
                    </td>
                    <td class="history-date">{{ s.created_at[:16] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="history-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <p>No sessions yet. Start a conversation to see history here.</p>
        <a href="/" class="btn btn-primary">Go to Chat</a>
    </div>
    {% endif %}
</div>

<!-- Detail modal -->
<div class="modal-overlay" id="detailModal" style="display: none;">
    <div class="modal-card">
        <div class="modal-header">
            <h3>Session Detail</h3>
            <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('detailModal');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');

    document.querySelectorAll('.history-row').forEach(row => {
        row.addEventListener('click', async () => {
            const sid = row.dataset.session;
            modal.style.display = 'flex';
            modalBody.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const resp = await fetch(`/api/sessions/${sid}`);
                const data = await resp.json();
                let html = '<div class="detail-grid">';
                html += `<div class="detail-item"><span class="detail-label">Session ID</span><span class="detail-value">${data.session_id}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">Patient</span><span class="detail-value">${data.patient_name || '—'}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">Status</span><span class="detail-value"><span class="status-badge status-${data.status}">${data.status}</span></span></div>`;
                html += `<div class="detail-item"><span class="detail-label">Condition</span><span class="detail-value">${data.condition_name || '—'}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">Created</span><span class="detail-value">${data.created_at}</span></div>`;
                html += '</div>';

                if (data.result) {
                    html += '<div class="detail-result"><h4>Result</h4><pre class="detail-json">' + JSON.stringify(data.result, null, 2) + '</pre></div>';
                }
                modalBody.innerHTML = html;
            } catch (e) {
                modalBody.innerHTML = '<p class="error-text">Failed to load session details.</p>';
            }
        });
    });

    modalClose.addEventListener('click', () => { modal.style.display = 'none'; });
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

    const clearBtn = document.getElementById('clearInactiveBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', async () => {
            if (!confirm('Delete all inactive (active/abandoned) sessions?')) return;
            try {
                const resp = await fetch('/api/sessions/inactive', { method: 'DELETE' });
                const data = await resp.json();
                clearBtn.textContent = `Deleted ${data.deleted} session${data.deleted !== 1 ? 's' : ''}`;
                clearBtn.disabled = true;
                setTimeout(() => location.reload(), 800);
            } catch (e) {
                alert('Failed to clear sessions.');
            }
        });
    }
});
</script>
{% endblock %}
